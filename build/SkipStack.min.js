function Grid(t,e,l,i,o,r){this.c=o,this.c2=r,this.cellsCountX=t,this.cellsCountY=e,this.cellWidth=l,this.cellHeight=i,this.grid,this.cell=new Array}function getRandom(){return Math.random()}function getRandomArbitrary(t,e){return Math.random()*(e-t)+t}function getRandomInt(t,e){return Math.floor(Math.random()*(e-t))+t}function mouseDragStart(){onDownPosX=game.input.mousePointer.x,onDownPosY=game.input.mousePointer.y}function mouseDragMove(){}function mouseDragEnd(){onEndPosX=game.input.mousePointer.x,onEndPosY=game.input.mousePointer.y;var t=onDownPosX-onEndPosX,e=onDownPosY-onEndPosY,l=Math.abs(t)>Editor_Width/3,i=Math.abs(e)>Editor_Width/3;(1==l||1==i)&&actor.move(1==i?Math.abs(e)>Math.abs(t)?e>0?"top":"bottom":t>0?"left":"right":t>0?"left":"right"),onDownPosX=onEndPosX=onDownPosY=onEndPosY=0}function Actor(t,e){this.color=t,this.block="undefined"==typeof e?Math.floor(cellsCntX/2)+"-"+Math.floor(cellsCntX/2):e,this._c,this.enemiesKilled=0}function Color(){this.Color_OceanBlue=10092543,this.Color_SteelBlue=4620980,this.Color_RoyalBlue=16711680,this.Color_DarkBlue=39423,this.Color_Black=0,this.Color_Violet=15631086,this.Color_Yellow=16776960,this.Color_Tomato=16737095,this.Color_PaleVioletRed=14381203,this.Color_Red=16711680,this.Color_Wheat=16113331,this.Color_AntiqueWhite=16444375,this.Color_White=16777215}function preload(){cellWidth=(Editor_Width-(2*cellsCntX+2))/cellsCntX,cellHeight=(Editor_Width-(2*cellsCntY+2))/cellsCntY}function create(){color=new Color,grid=new Grid(cellsCntX,cellsCntY,cellWidth,cellHeight,"#333","#ffffff"),actor=new Actor("#006400"),enemy=[new Enemy(enemiesColor,"0-0"),new Enemy(enemiesColor,cellsCntX-1+"-0"),new Enemy(enemiesColor,cellsCntX-2+"-"+(cellsCntY-2))];for(var t=0;gameStateRestarts>t;t++)enemy.push(new Enemy(enemiesColor,getRandomInt(0,cellsCntX)+"-"+getRandomInt(0,cellsCntX)));game.add.plugin(Phaser.Plugin.Debug),game.input.onDown.add(mouseDragStart,this),game.input.addMoveCallback(mouseDragMove,this),game.input.onUp.add(mouseDragEnd,this),grid.init(),actor.init();for(var t=0;t<enemy.length;t++)enemy[t].init()}function update(){if(game.time.time>EnemyMoveTimeout){for(var t=0;t<enemy.length;t++)enemy[t].update();EnemyMoveTimeout=game.time.time+1e3}}function render(){grid.render()}function Enemy(t,e){this.color=t,"undefined"==typeof e?alert('Error : "blockID" is undefined'):this.block=e,this.isDead=!1,this._c}function Cell(t,e,l,i){this.color=i,this.positionX=t,this.positionY=e,this.HashId=l,this.rect,this.init(),this.type="Normal"}Grid.prototype.init=function(){var t=this.cellsCountX*this.cellWidth+2*this.cellsCountX+2,e=this.cellsCountY*this.cellHeight+2*this.cellsCountY+2;this.grid=new Phaser.Rectangle((Editor_Width-t)/2,(Editor_Height-e)/2,t,e),e=(Editor_Height-e)/2,t=(Editor_Width-t)/2;for(var l=0;l<this.cellsCountY;l++)for(var i=0;i<this.cellsCountX;i++){var o=t+2*(i+1)+this.cellWidth*i,r=e+2*(l+1)+this.cellHeight*l;this.cell.push(new Cell(o,r,i.toString()+"-"+l.toString(),this.c2))}},Grid.prototype.getCell=function(t){for(var e=0;e<this.cell.length;e++)if(this.cell[e].HashId==t)return e},Grid.prototype.render=function(){game.debug.geom(this.grid,this.c);for(var t=0;t<this.cell.length;t++)this.cell[t].render()},Grid.prototype.getRow=function(t){for(var e=grid.cellsCountX,l=0;l<grid.cellsCountX;l++){if(e>t)return l;e+=grid.cellsCountX}};var randomBoolean=[function(){return Math.random()<.5},function(){return!(Math.random()+.5|0)},function(){return!(+new Date%2)}],onDownPosX,onDownPosY,onEndPosX,onEndPosY;Actor.prototype.init=function(){this._c=grid.getCell(this.block),grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Actor")},Actor.prototype.move=function(t){switch(t){case"top":grid.cell[this._c].checkCell(t,this._c)&&(grid.cell[this._c].setCellType("Normal"),grid.cell[this._c].setColor(grid.c2),this._c=this._c-cellsCntX,grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Actor"));break;case"bottom":grid.cell[this._c].checkCell(t,this._c)&&(grid.cell[this._c].setCellType("Normal"),grid.cell[this._c].setColor(grid.c2),this._c=this._c+cellsCntX,grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Actor"));break;case"left":grid.cell[this._c].checkCell(t,this._c)&&(grid.cell[this._c].setCellType("Normal"),grid.cell[this._c].setColor(grid.c2),this._c=this._c-1,grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Actor"));break;case"right":grid.cell[this._c].checkCell(t,this._c)&&(grid.cell[this._c].setCellType("Normal"),grid.cell[this._c].setColor(grid.c2),this._c=this._c+1,grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Actor"))}},Color.prototype.generateHexColor=function(){return"#"+(16777215*(.5+.5*Math.random())<<0).toString(16)};var GameType="Normal",blips_sfx=jsfxlib.createWave(["sine",0,.4,0,.092,0,.208,20,286,2400,-.674,0,0,.01,3e-4,0,0,0,0,0,0,0,0,1,0,0,.048,0]),EnemyMoveTimeout=0,Editor_Width=256,Editor_Height=256,aspect_ratio=Editor_Width/Editor_Height,World_bounds_x=Editor_Width,World_bounds_y=Editor_Height,cellsCntX=7,cellsCntY=7,cellWidth,cellHeight,enemiesColor="#b50000",gameStateRestarts=0,color,grid,actor,enemy,game=new Phaser.Game(Editor_Width,Editor_Height,Phaser.AUTO,"SkipStack",{preload:preload,create:create,update:update,render:render});Enemy.prototype.init=function(){this._c=grid.getCell(this.block),grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Enemy")},Enemy.prototype.update=function(){if(1==this.isDead)return null;var t=actor._c-this._c,e=Math.abs(grid.getRow(actor._c)-grid.getRow(this._c));0>t?this.move(e>0?"top":this._c>actor._c?"left":"right"):0===t?(alert("He's Dead, Romane!"),cellsCntX+=1,cellsCntY+=1,gameStateRestarts++,game.state.start(game.state.current)):this.move(e>0?"bottom":this._c>actor._c?"left":"right")},Enemy.prototype.move=function(t){switch(t){case"top":(grid.cell[this._c].checkCell(t,this._c)||"Enemy"===grid.cell[this._c-cellsCntX].type)&&(grid.cell[this._c].setCellType("Normal"),grid.cell[this._c].setColor(grid.c2),this._c=this._c-cellsCntX,grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Enemy"));break;case"bottom":(grid.cell[this._c].checkCell(t,this._c)||"Enemy"===grid.cell[this._c+cellsCntX].type)&&(grid.cell[this._c].setCellType("Normal"),grid.cell[this._c].setColor(grid.c2),this._c=this._c+cellsCntX,grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Enemy"));break;case"left":(grid.cell[this._c].checkCell(t,this._c)||"Enemy"===grid.cell[this._c-1].type)&&(grid.cell[this._c].setCellType("Normal"),grid.cell[this._c].setColor(grid.c2),this._c=this._c-1,grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Enemy"));break;case"right":(grid.cell[this._c].checkCell(t,this._c)||"Enemy"===grid.cell[this._c+1].type)&&(grid.cell[this._c].setCellType("Normal"),grid.cell[this._c].setColor(grid.c2),this._c=this._c+1,grid.cell[this._c].setColor(this.color),grid.cell[this._c].setCellType("Enemy"))}},Enemy.prototype.Nextmove=function(){if(this.isDead===!0)return null;var t=actor._c-this._c,e=Math.abs(grid.getRow(actor._c)-grid.getRow(this._c));return 0>t?e>0?"top":this._c>actor._c?"left":"right":0!==t?e>0?"bottom":this._c>actor._c?"left":"right":void alert("He's Dead, Romane!")},Cell.prototype.init=function(){this.rect=new Phaser.Rectangle(this.positionX,this.positionY,grid.cellWidth,grid.cellWidth)},Cell.prototype.setCellType=function(t){"Normal"!=t&&"Enemy"!=t&&"Actor"!=t&&alert('type can only be "Enemy","Normal","Actor"'),this.type=t},Cell.prototype.render=function(){game.debug.geom(this.rect,this.color)},Cell.prototype.setColor=function(t){this.color=t},Cell.prototype.checkCell=function(t,e){var l=!0;switch(t){case"top":l=cellsCntX>e?!1:!0;break;case"bottom":l=e>cellsCntX*grid.cellsCountY-cellsCntX?!1:!0;break;case"left":for(var i=0;cellsCntX>i;i++)e===cellsCntX*i&&(l=!1);if(0==l)break;l=!0;break;case"right":for(var i=0;cellsCntX>i;i++)e===cellsCntX*i-1&&(l=!1);if(0==l)break;l=!0}return l};
